#!/bin/bash

set -e
set -o pipefail

USER=faham
HOME=/home/$USER

pacman -S sudo patch --noconfirm

usermod -G disk --append $USER
usermod -G sys --append $USER

[ -f /etc/gdm/custom.conf ] && sed  -i "s/^#WaylandEnable=false/WaylandEnable=false/" /etc/gdm/custom.conf
patch -r - /etc/sudoers $HOME/bin/files/sudoers.patch
patch -r - /etc/pacman.conf $HOME/bin/files/pacman.conf.patch
cp $HOME/bin/files/motd /etc/motd
cp ~/.scripts/files/screenlock-suspend.service /usr/lib/systemd/system/
cp ~/.scripts/files/screenlock-hibernate.service /usr/lib/systemd/system/

PACKAGES="
aria2 autoconf automake cmake cmus ctags cups dmenu downgrade evince
exfat-utils fakeroot festival-us fluxbox freerdp gdb ghostscript gimp git
gparted gpicview gsfonts gvfs gvfs-mtp htop i3-wm i3lock i3blocks imagemagick
libva-intel-driver libvdpau-va-gl linux-headers mesa-libgl
mutagen nmap ntfs-3g openssh p7zip patch pcmanfm picard pkg-config pulseaudio
python-pip python2 python2-pip qalculate-gtk rdesktop rsync samba scrot sshfs
sudo terminus-font tk tmux ttf-bitstream-vera ttf-dejavu ttf-font-awesome
ttf-freefont ttf-inconsolata ttf-liberation ttf-linux-libertine
ttf-ubuntu-font-family unclutter unzip vim vim-spell-en virtualbox
virtualbox-guest-utils virtualbox-host-dkms vlc wget wpa_actiond xautolock
xbindkeys xclip xdot xdotool xf86-input-synaptics xf86-video-intel xloadimage
xorg-apps xorg-fonts-100dpi xorg-fonts-75dpi xorg-server xorg-xinit
xorg-xmessage xosd xterm yaourt youtube-dl zip zsh netctl-vpnc mplayer mosh
rofi sysstat acpi
"
#pm-utils xorg-server-utils

pacman -Syy
pacman -S $PACKAGES --noconfirm

systemctl enable screenlock-suspend.service
systemctl start screenlock-suspend.service
systemctl enable screenlock-hibernate.service
systemctl start screenlock-hibernate.service
systemctl enable sshd.service
systemctl start sshd.service
systemctl enable sshd.socket
systemctl start sshd.socket
systemctl enable netctl-auto@.service
systemctl start netctl-auto@.service

$HOME/bin/set-python 2
pip install twisted argparse
$HOME/bin/set-python 3

ln -s /etc/fonts/conf.avail/ /etc/fonts/conf.d

# required groups membership for cups administration at http://http://127.0.0.1:631/
gpasswd -a $USER lp
gpasswd -a $USER sys

su $USER
yaourt -S google-chrome git-crypt xvkbd laptop-mode-tools
git submodule update --init --recursive

su root
[ -f /usr/bin/subl ] || ln -s /usr/bin/subl3 /usr/bin/subl
[ -f /etc/ssh/sshd_config ] && patch -r - /etc/ssh/sshd_config $HOME/bin/files/sshd_config.patch

